<!DOCTYPE html>
<html>
	<head>
		<title>bmy</title>
		<meta charset="utf-8">
		<link id="bootstrap-style" href="static/css/bootstrap.min.css" rel="stylesheet">
		<link href="static/css/bootstrap-theme.min.css" rel="stylesheet">
		<link href="css/style.css" rel="stylesheet">
		<link href="css/showloginpics.css" rel="stylesheet">
		<style type="text/css">
			body { background: #eee;}
			.container { min-width: 1200px !important;}
		</style>
	</head>

	<body>
		<div class="container">
			<div id="img-wrapper" class="float-right">
				<div id="img-container"></div>
				<div id="img-nav"></div>
			</div>

			<div class="form-signin float-left">
				<h2>欢迎访问兵马俑 BBS</h2>
				<div id="login-form" class="hidden">
					<input class="form-control input-lg" autofocus="" id="username" type="text" placeholder="用户名">

					<input class="form-control input-lg" id="password" type="password" placeholder="密码">
					<label><input id="chk_remember" type="checkbox">记住我</label>
					<button id="btn-login" class="btn btn-primary btn-lg btn-block" type="submit">登录</button>
				</div>
				<div id="direct-login" class="hidden">
					<h3>您已登录系统，请直接进入</h3>
					<button id="btn-direct-login" class="btn btn-primary btn-lg btn-block" type="submit">登录</button>
				</div>
				<div id="bmy-links">
					<div class="bmy-link-line">
						<a href="#">匿名登录</a>
						<a href="#">telnet登录</a>
					</div>
					<div class="bmy-link-line">
						<a href="#">CTerm工具下载</a>
						<span id="newreg">新用户注册</span>
					</div>
					<div class="bmy-link-line">
						<a href="#">老 Web</a>
						<a href="#">找回密码</a>
					</div>
				</div>
			</div>
		</div>
		<div id="reg-box" class="popup">
			<span class="bpopup-button b-close"><span>X</span></span>
			<form class="form-horizontal" role="form">
				<div class="form-group">
					<label for="reg-username" class="col-lg-2 control-label">用户名</label>
					<div class="col-lg-10">
						<input type="text" class="form-control input-lg" id="reg-username" placeholder="用户名">
					</div>
				</div>

				<div class="form-group">
					<label for="reg-password" class="col-lg-2 control-label">密码</label>
					<div class="col-lg-10">
						<input type="password" class="form-control input-lg" id="reg-password" placeholder="密码">
					</div>
				</div>

				<div class="form-group">
					<label for="reg-activecode" class="col-lg-2 control-label">激活码</label>
					<div class="col-lg-10">
						<input type="text" class="form-control input-lg" id="reg-activecode" placeholder="激活码">
					</div>
				</div>

				<div class="form-group">
					<div class="col-lg-offset-2 col-lg-10">
						<button id="reg-btn" class="btn btn-primary btn-lg">注册</button>
					</div>
				</div>
			</form>
		</div>
		<footer><div class="container">陕ICP备 05001571号</div></footer>
		<script src="static/js/jquery-1.10.2.min.js"></script>
		<script src="static/js/jquery.bpopup.min.js"></script>
		<script src="js/bmy.js"></script>
		<script src="js/showloginpics.js"></script>
		<script>
			var reg_pop;
			$(document).ready(function (){
				$('#newreg').click(function() {
					reg_pop = $('#reg-box').bPopup({
						modalClose: false,
						opacity: 0.6,
						positionStyle: 'fixed'
					});
				});

				$("reg-btn").click(function() {
					var reg_userid = $('#reg-username').val();
					var reg_passwd = $('#reg-password').val();
					var reg_active = $('#reg-activecode').val().toUpperCase();

					$.ajax({
						type: "POST",
						url: "api/user/register?userid="+reg_userid+"&passwd="+reg_passwd+"&activation="+reg_active,
						dataType: "json",
						success: function(data) {
							if(data.errcode == 0) {
								alert('注册成功，请返回登录!');
								reg_pop.close();
							} else {
								alert('好像哪边出了点错误 :-(');
							}
						}
					});
				});

				// load login pics
				$.ajax({
					type: "GET",
					url: "api/meta/loginpics",
					dataType: "json",
					success: function(data) {
						if(data.errcode == 0)
							showloginpics(data.pics);
					}
				});

				var userid = localStorage.userid;
				var sessid = localStorage.sessid;
				var is_local_rmbme = localStorage.is_rmbme;

				if(typeof(is_local_rmbme) == 'undefined' || typeof(userid) == 'undefined' || typeof(sessid) == 'undefined') {
					$('div#login-form').removeClass('hidden');
				} else if(is_local_rmbme==null || userid==null || sessid==null) {
					$('div#login-form').removeClass('hidden');
				} else {
					var url_checksession = 'api/user/checksession?userid='+userid+'&sessid='+sessid+'&appkey=newweb';

					$.getJSON(url_checksession, function(data) {
						if(data.errcode == 0) {
							$('div#direct-login').removeClass('hidden');
						} else {
							$('div#login-form').removeClass('hidden');
						}
					})
					.fail(function() {
						$('div#login-form').removeClass('hidden');
					});
				}

				bind_login_button(function() {
					document.location.href = 'app.html';
				});

				$('#btn-direct-login').click(function() {
					document.location.href = 'app.html';
				});
			});
		</script>
	</body>
</html>
